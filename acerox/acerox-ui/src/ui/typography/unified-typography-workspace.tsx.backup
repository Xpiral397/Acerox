"use client";

import { useState, useEffect, useMemo } from "react";
import { useTypography } from "@/state/typography";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Separator } from "@/components/ui/separator";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { motion } from "framer-motion";
import {
  Plus,
  Download,
  Copy,
  Trash2,
  Type,
  FileJson,
  FileCode,
  Code2,
  Eye,
  Folder,
  FileText,
  X,
  Minimize2,
} from "lucide-react";
import { useTheme } from "next-themes";
import { FontPicker } from "./font-picker";
import { AnimationPanel } from "@/ui/sidebars/animation-panel";
import { TimelineEditor } from "@/ui/sidebars/timeline-editor";
import { ResizablePanel, ResizablePanelGroup, ResizableHandle } from "@/components/ui/resizable";

export default function UnifiedTypographyWorkspace() {
  const [previewBg, setPreviewBg] = useState("#ffffff");
  const [previewText, setPreviewText] = useState("The quick brown fox jumps over the lazy dog");
  const [activePreviewTab, setActivePreviewTab] = useState<"preview" | "code">("preview");
  const [isAdvancedPanelCollapsed, setIsAdvancedPanelCollapsed] = useState(false);
  const [activeSection, setActiveSection] = useState<"gradient" | "typography" | "effects" | "actions">("gradient");
  const [hasHydrated, setHasHydrated] = useState(false);
  const { theme } = useTheme();

  const stylesObj = useTypography((s) => s.styles);
  const styles = Object.values(stylesObj);
  const selectedStyleId = useTypography((s) => s.selectedStyleId);
  const selectStyle = useTypography((s) => s.selectStyle);
  const createStyle = useTypography((s) => s.createStyle);
  const updateStyle = useTypography((s) => s.updateStyle);
  const deleteStyle = useTypography((s) => s.deleteStyle);
  const duplicateStyle = useTypography((s) => s.duplicateStyle);
  const exportAsCSS = useTypography((s) => s.exportAsCSS);

  // Wait for Zustand persist to hydrate
  useEffect(() => {
    setHasHydrated(true);
  }, []);

  // Helper to extract animation values from stored properties
  const getAnimationValues = (properties: Record<string, any> | undefined) => {
    if (!properties) return { initial: { opacity: 0, y: 20 }, animate: { opacity: 1, y: 0 } };

    const initial: any = {};
    const animate: any = {};

    Object.keys(properties).forEach((key) => {
      const value = properties[key];

      // Convert CSS property names to framer-motion names
      let motionKey = key;
      if (key === 'translateX') motionKey = 'x';
      else if (key === 'translateY') motionKey = 'y';
      else if (key === 'translateZ') motionKey = 'z';

      // Handle array values
      if (Array.isArray(value)) {
        initial[motionKey] = value[0];
        animate[motionKey] = value;
      } else {
        // Single value - use as both initial and animate
        animate[motionKey] = value;
      }
    });

    return { initial, animate };
  };

  // Convert CSS easing to framer-motion compatible easing
  const convertEasing = (cssEasing: string): any => {
    const easingMap: Record<string, any> = {
      "ease-out": "easeOut",
      "ease-in": "easeIn",
      "ease-in-out": "easeInOut",
      "ease": "easeInOut",
      "linear": "linear",
    };

    if (easingMap[cssEasing]) {
      return easingMap[cssEasing];
    }

    const cubicBezierMatch = cssEasing.match(/cubic-bezier\(([\d.,\s-]+)\)/);
    if (cubicBezierMatch) {
      const values = cubicBezierMatch[1].split(",").map((v) => parseFloat(v.trim()));
      return values;
    }

    return "easeOut";
  };

  // Update gradient property
  const updateGradient = (updates: Partial<{
    enabled: boolean;
    type: "linear" | "radial" | "conic";
    angle: number;
    stops: Array<{ color: string; position: number }>;
  }>) => {
    if (!selectedStyleId) return;
    const style = stylesObj[selectedStyleId];
    updateStyle(selectedStyleId, {
      gradient: {
        ...(style.gradient || {
          enabled: false,
          type: "linear",
          angle: 90,
          stops: [
            { color: "#3b82f6", position: 0 },
            { color: "#a855f7", position: 100 },
          ],
        }),
        ...updates,
      },
    });
  };

  // Create default style if none exist and auto-select it
  useEffect(() => {
    if (!hasHydrated) return;

    if (styles.length === 0) {
      createStyle({
        name: "Default Heading",
        fontFamily: "Inter, sans-serif",
        fontSize: "32px",
        fontWeight: 700,
        lineHeight: "1.2",
        letterSpacing: "-0.02em",
        color: "#000000",
        category: "heading",
      });
    } else if (!selectedStyleId && styles.length > 0) {
      // Auto-select first style if none selected
      selectStyle(styles[0].id);
    }
  }, [hasHydrated, styles.length, selectedStyleId, createStyle, selectStyle]);

  // Auto-adjust preview background based on theme
  useEffect(() => {
    if (theme === "dark") {
      setPreviewBg("#1a1a1a");
    } else {
      setPreviewBg("#ffffff");
    }
  }, [theme]);

  const selectedStyle = selectedStyleId ? stylesObj[selectedStyleId] : null;

  const exportAsTokens = () => {
    const tokens = Object.values(stylesObj).reduce((acc, style) => {
      const tokenName = style.name.toLowerCase().replace(/\s+/g, "-");
      acc[tokenName] = {
        fontFamily: style.fontFamily,
        fontSize: style.fontSize,
        fontWeight: style.fontWeight,
        lineHeight: style.lineHeight,
        letterSpacing: style.letterSpacing,
        color: style.color,
      };
      return acc;
    }, {} as Record<string, unknown>);

    const blob = new Blob([JSON.stringify(tokens, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "typography-tokens.json";
    a.click();
    URL.revokeObjectURL(url);
  };

  const exportAsComponent = () => {
    if (!selectedStyle) return;

    const componentName = selectedStyle.name.replace(/\s+/g, "");
    const componentCode = `import React from 'react';

interface ${componentName}Props {
  children: React.ReactNode;
  className?: string;
}

export const ${componentName} = ({ children, className = '' }: ${componentName}Props) => {
  return (
    <div
      className={className}
      style={{
        fontFamily: '${selectedStyle.fontFamily}',
        fontSize: '${selectedStyle.fontSize}',
        fontWeight: ${selectedStyle.fontWeight},
        lineHeight: '${selectedStyle.lineHeight}',
        letterSpacing: '${selectedStyle.letterSpacing}',
        color: '${selectedStyle.color}',
      }}
    >
      {children}
    </div>
  );
};
`;

    const blob = new Blob([componentCode], { type: "text/typescript" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${componentName}.tsx`;
    a.click();
    URL.revokeObjectURL(url);
  };

  // Generate CSS code for preview
  const generatedCSS = useMemo(() => {
    if (!selectedStyle) return "";

    const className = selectedStyle.name.toLowerCase().replace(/\s+/g, "-");
    return `.${className} {
  font-family: ${selectedStyle.fontFamily};
  font-size: ${selectedStyle.fontSize};
  font-weight: ${selectedStyle.fontWeight};
  line-height: ${selectedStyle.lineHeight};
  letter-spacing: ${selectedStyle.letterSpacing};
  color: ${selectedStyle.color};
}`;
  }, [selectedStyle]);

  const bgPresets = ["#ffffff", "#f5f5f5", "#1a1a1a", "#000000", "#1e3a8a", "#581c87"];

  if (!hasHydrated) {
    return (
      <div className="h-full flex items-center justify-center">
        <div className="text-sm text-muted-foreground">Loading typography workspace...</div>
      </div>
    );
  }

  return (
    <div className="h-full w-full flex relative bg-muted/5 p-2">
      {selectedStyle ? (
        <ResizablePanelGroup direction="vertical">
          {/* Top Row */}
          <ResizablePanel defaultSize={60} minSize={30}>
            <ResizablePanelGroup direction="horizontal">
              {/* Preview/Code Widget */}
              <ResizablePanel defaultSize={50} minSize={30}>
                <div className="h-full mr-2 rounded-lg border bg-background shadow-sm flex flex-col overflow-hidden">
                  <div className="flex items-center justify-between px-4 py-2 border-b bg-muted/30">
                    <div className="flex items-center gap-2">
                      <Eye className="h-4 w-4 text-primary" />
                      <h3 className="text-xs font-semibold">Typography Preview</h3>
                    </div>
                    <div className="flex items-center gap-1">
                      <button
                        onClick={() => setActivePreviewTab("preview")}
                        className={`px-3 py-1.5 text-xs font-medium rounded transition ${
                          activePreviewTab === "preview"
                            ? "bg-primary text-primary-foreground"
                            : "hover:bg-accent"
                        }`}
                      >
                        Preview
                      </button>
                      <button
                        onClick={() => setActivePreviewTab("code")}
                        className={`px-3 py-1.5 text-xs font-medium rounded transition ${
                          activePreviewTab === "code"
                            ? "bg-primary text-primary-foreground"
                            : "hover:bg-accent"
                        }`}
                      >
                        Code
                      </button>
                    </div>
                  </div>

                  <div className="flex-1 p-4 overflow-y-auto min-h-0">
                    {activePreviewTab === "preview" ? (
                      <div className="flex flex-col gap-3 h-full">
                        <div className="space-y-1.5 flex-shrink-0">
                          <Label className="text-xs font-medium">Preview Text</Label>
                          <textarea
                            value={previewText}
                            onChange={(e) => setPreviewText(e.target.value)}
                            placeholder="Enter preview text..."
                            className="w-full h-20 p-2 rounded border bg-background text-xs resize-none"
                          />
                        </div>

                        <div className="space-y-1.5 flex-shrink-0">
                          <Label className="text-xs font-medium">Background Color</Label>
                          <div className="flex gap-2">
                            {bgPresets.map((bg) => (
                              <button
                                key={bg}
                                onClick={() => setPreviewBg(bg)}
                                className={`w-7 h-7 rounded border-2 transition ${
                                  previewBg === bg
                                    ? "border-primary ring-2 ring-primary/20"
                                    : "border-border hover:border-primary/50"
                                }`}
                                style={{ backgroundColor: bg }}
                              />
                            ))}
                            <input
                              type="color"
                              value={previewBg}
                              onChange={(e) => setPreviewBg(e.target.value)}
                              className="w-7 h-7 rounded border-2 cursor-pointer"
                            />
                          </div>
                        </div>

                        <div
                          className="flex-1 rounded-lg border-2 border-dashed p-6 transition-colors overflow-auto"
                          style={{ backgroundColor: previewBg }}
                        >
                          {selectedStyle.keyframes && selectedStyle.keyframes.length > 0 ? (() => {
                            // Use keyframes if available (from timeline editor)
                            const keyframes = selectedStyle.keyframes;
                            const totalDuration = Math.max(...keyframes.map((kf) => kf.time));

                            // Collect all unique properties across all keyframes
                            const allProperties = new Set<string>();
                            keyframes.forEach(kf => {
                              Object.keys(kf.properties).forEach(key => allProperties.add(key));
                            });

                            // Build framer-motion keyframe animation with consistent properties
                            const animationValues: Record<string, any[]> = {};
                            const times: number[] = [];
                            const initial: Record<string, any> = {};

                            keyframes.forEach((kf, index) => {
                              const timePercent = totalDuration > 0 ? kf.time / totalDuration : 0;
                              times.push(timePercent);

                              // Process all properties, using previous value if not present in this keyframe
                              allProperties.forEach((key) => {
                                // Convert CSS property names to framer-motion names
                                let motionKey = key;
                                if (key === 'translateX') motionKey = 'x';
                                else if (key === 'translateY') motionKey = 'y';
                                else if (key === 'translateZ') motionKey = 'z';

                                if (!animationValues[motionKey]) {
                                  animationValues[motionKey] = [];
                                }

                                // Use current value if exists, otherwise use previous value or default
                                const value = kf.properties[key] !== undefined
                                  ? kf.properties[key]
                                  : (index > 0 ? animationValues[motionKey][index - 1] : (motionKey === 'opacity' ? 1 : 0));

                                animationValues[motionKey].push(value);

                                // Set initial values from first keyframe
                                if (index === 0) {
                                  initial[motionKey] = value;
                                }
                              });
                            });

                            return (
                              <motion.div
                                key={`${previewText}-${selectedStyle.id}-keyframes-${JSON.stringify(keyframes)}`}
                                initial={initial}
                                animate={animationValues}
                                transition={{
                                  duration: totalDuration,
                                  times: times,
                                  ease: keyframes[0]?.transition?.easing ? convertEasing(keyframes[0].transition.easing) : "easeOut",
                                  repeat: Infinity,
                                  repeatDelay: 0.5,
                                }}
                                className="whitespace-pre-wrap break-words"
                                style={{
                                  fontFamily: selectedStyle.fontFamily,
                                  fontSize: selectedStyle.fontSize,
                                  fontWeight: selectedStyle.fontWeight,
                                  lineHeight: selectedStyle.lineHeight,
                                  letterSpacing: selectedStyle.letterSpacing,
                                  color: selectedStyle.gradient?.enabled ? "transparent" : selectedStyle.color,
                                  ...(selectedStyle.gradient?.enabled && {
                                    backgroundImage: (() => {
                                      const g = selectedStyle.gradient;
                                      const stops = g.stops.map((s) => `${s.color} ${s.position}%`).join(", ");
                                      if (g.type === "linear") {
                                        return `linear-gradient(${g.angle}deg, ${stops})`;
                                      } else if (g.type === "radial") {
                                        return `radial-gradient(circle, ${stops})`;
                                      } else {
                                        return `conic-gradient(from ${g.angle}deg, ${stops})`;
                                      }
                                    })(),
                                    backgroundClip: "text",
                                    WebkitBackgroundClip: "text",
                                    WebkitTextFillColor: "transparent",
                                  }),
                                }}
                              >
                                {previewText}
                              </motion.div>
                            );
                          })() : selectedStyle.animation ? (() => {
                            // Fallback to simple animation if no keyframes
                            const { initial, animate } = getAnimationValues(selectedStyle.animation.properties);
                            return (
                              <motion.div
                                key={`${previewText}-${selectedStyle.id}-${JSON.stringify(selectedStyle.animation)}`}
                                initial={initial}
                                animate={animate}
                                transition={{
                                  duration: (selectedStyle.animation.duration || 800) / 1000,
                                  ease: convertEasing(selectedStyle.animation.easing || "ease-out"),
                                  repeat: Infinity,
                                  repeatDelay: 0.5,
                                }}
                                className="whitespace-pre-wrap break-words"
                                style={{
                                  fontFamily: selectedStyle.fontFamily,
                                  fontSize: selectedStyle.fontSize,
                                  fontWeight: selectedStyle.fontWeight,
                                  lineHeight: selectedStyle.lineHeight,
                                  letterSpacing: selectedStyle.letterSpacing,
                                  color: selectedStyle.gradient?.enabled ? "transparent" : selectedStyle.color,
                                  ...(selectedStyle.gradient?.enabled && {
                                    backgroundImage: (() => {
                                      const g = selectedStyle.gradient;
                                      const stops = g.stops.map((s) => `${s.color} ${s.position}%`).join(", ");
                                      if (g.type === "linear") {
                                        return `linear-gradient(${g.angle}deg, ${stops})`;
                                      } else if (g.type === "radial") {
                                        return `radial-gradient(circle, ${stops})`;
                                      } else {
                                        return `conic-gradient(from ${g.angle}deg, ${stops})`;
                                      }
                                    })(),
                                    backgroundClip: "text",
                                    WebkitBackgroundClip: "text",
                                    WebkitTextFillColor: "transparent",
                                  }),
                                }}
                              >
                                {previewText}
                              </motion.div>
                            );
                          })() : (
                            <div
                              className="whitespace-pre-wrap break-words"
                              style={{
                                fontFamily: selectedStyle.fontFamily,
                                fontSize: selectedStyle.fontSize,
                                fontWeight: selectedStyle.fontWeight,
                                lineHeight: selectedStyle.lineHeight,
                                letterSpacing: selectedStyle.letterSpacing,
                                color: selectedStyle.gradient?.enabled ? "transparent" : selectedStyle.color,
                                ...(selectedStyle.gradient?.enabled && {
                                  backgroundImage: (() => {
                                    const g = selectedStyle.gradient;
                                    const stops = g.stops.map((s) => `${s.color} ${s.position}%`).join(", ");
                                    if (g.type === "linear") {
                                      return `linear-gradient(${g.angle}deg, ${stops})`;
                                    } else if (g.type === "radial") {
                                      return `radial-gradient(circle, ${stops})`;
                                    } else {
                                      return `conic-gradient(from ${g.angle}deg, ${stops})`;
                                    }
                                  })(),
                                  backgroundClip: "text",
                                  WebkitBackgroundClip: "text",
                                  WebkitTextFillColor: "transparent",
                                }),
                              }}
                            >
                              {previewText}
                            </div>
                          )}
                        </div>
                      </div>
                    ) : (
                      <div className="flex flex-col gap-3 h-full">
                        <div className="flex items-center justify-between flex-shrink-0">
                          <Label className="text-xs font-medium">Generated CSS</Label>
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => navigator.clipboard.writeText(generatedCSS)}
                            className="h-7 text-xs"
                          >
                            <Copy className="h-3 w-3 mr-1" />
                            Copy
                          </Button>
                        </div>
                        <pre className="flex-1 p-4 rounded-lg bg-muted/30 border overflow-auto text-xs font-mono min-h-0">
                          <code>{generatedCSS}</code>
                        </pre>
                      </div>
                    )}
                  </div>
                </div>
              </div>

              

              {/* Animation Keyframe Editor Widget */}
              <div className="flex-1 min-h-0">
                <div className="h-full ml-1 rounded-lg border bg-background shadow-sm flex flex-col overflow-hidden">
                  <div className="flex items-center justify-between px-4 py-2 border-b bg-muted/30">
                    <div className="flex items-center gap-2">
                      <Code2 className="h-4 w-4 text-primary" />
                      <h3 className="text-xs font-semibold">Animation</h3>
                    </div>
                  </div>
                  <div className="flex-1 overflow-y-auto">
                    {selectedStyle ? (
                      <AnimationPanel styleId={selectedStyle.id} />
                    ) : (
                      <div className="p-4 text-center text-sm text-muted-foreground">
                        Select a style to edit animations
                      </div>
                    )}
                  </div>
                </div>
              </div>
              </div>
            </div>
          </div>

          

          {/* Bottom Row */}
          <div className="flex-1 min-h-0">
            <div className="h-full w-full">
              <div className="w-full h-full flex flex-row gap-2">
              {/* File Manager Widget */}
              <div className="flex-1 min-h-0">
                <div className="h-full mr-2 rounded-lg border bg-background shadow-sm flex flex-col overflow-hidden">
                  <div className="px-4 py-2 border-b flex items-center justify-between bg-muted/30">
                    <div className="flex items-center gap-2">
                      <FileCode className="h-4 w-4 text-primary" />
                      <h4 className="text-xs font-semibold">Files</h4>
                    </div>
                    <Button
                      size="sm"
                      variant="ghost"
                      onClick={() => {
                        const fileName = prompt("File name (without extension):");
                        if (fileName) {
                          createStyle({
                            name: fileName,
                            fontFamily: "Inter, sans-serif",
                            fontSize: "16px",
                            fontWeight: 400,
                            lineHeight: "1.5",
                            letterSpacing: "0",
                            color: theme === "dark" ? "#ffffff" : "#000000",
                            category: "custom",
                          });
                        }
                      }}
                      className="h-7 px-2"
                    >
                      <Plus className="h-3 w-3" />
                    </Button>
                  </div>

                  <div className="flex-1 overflow-y-auto p-3 flex flex-col gap-4">
                    {/* @fonts section */}
                    <div className="space-y-1">
                      <div className="flex items-center gap-2 px-2 py-1.5 text-xs font-medium text-muted-foreground bg-muted/40 rounded">
                        <Folder className="h-4 w-4" />
                        <span>@fonts</span>
                      </div>

                      <div className="ml-3 mt-2 space-y-0.5">
                        {styles.length === 0 ? (
                          <div className="text-xs text-muted-foreground px-3 py-6 text-center">
                            No files yet. Click + to create.
                          </div>
                        ) : (
                          styles.map((style) => (
                            <button
                              key={style.id}
                              onClick={() => selectStyle(style.id)}
                              className={`w-full flex items-center gap-2 px-3 py-2 rounded text-xs transition-colors ${
                                selectedStyleId === style.id
                                  ? "bg-primary/10 text-primary border border-primary/20"
                                  : "hover:bg-accent/50"
                              }`}
                            >
                              <FileText className="h-4 w-4" />
                              <span className="flex-1 truncate text-left font-medium">{style.name}.acrx</span>
                              {style.animation && (
                                <Badge variant="secondary" className="text-[8px] h-4 px-1.5">
                                  ▶
                                </Badge>
                              )}
                            </button>
                          ))
                        )}
                      </div>
                    </div>

                    {/* Timeline Editor section */}
                    <Separator />
                    <div className="space-y-2">
                      <div className="flex items-center gap-2 px-2 py-1.5 text-xs font-medium text-muted-foreground bg-muted/40 rounded">
                        <Code2 className="h-4 w-4" />
                        <span>Text Timeline</span>
                      </div>
                      <div className="border rounded-lg bg-background/50">
                        {selectedStyle ? (
                          <TimelineEditor
                            styleId={selectedStyle.id}
                            previewText={previewText}
                          />
                        ) : (
                          <div className="p-4 text-center text-xs text-muted-foreground">
                            Select a font to edit timeline
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              

              {/* Advanced Text Processing Widget */}
              {!isAdvancedPanelCollapsed && (
                <div className="flex-1 min-h-0">
                  <div className="h-full ml-1 rounded-lg border bg-background shadow-sm flex flex-col overflow-hidden">
                    <div className="px-4 py-2 border-b flex items-center justify-between bg-muted/30">
                      <div className="flex items-center gap-2">
                        <Type className="h-4 w-4 text-primary" />
                        <h4 className="text-xs font-semibold">Advanced Text Processing</h4>
                      </div>
                      <div className="flex items-center gap-1">
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => setIsAdvancedPanelCollapsed(true)}
                          className="h-6 w-6 p-0"
                        >
                          <Minimize2 className="h-3 w-3" />
                        </Button>
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => setIsAdvancedPanelCollapsed(true)}
                          className="h-6 w-6 p-0"
                        >
                          <X className="h-3 w-3" />
                        </Button>
                      </div>
                    </div>

                    <div className="flex-1 overflow-auto flex flex-col">
                      {/* Simple Navbar */}
                      <div className="flex items-center gap-1 px-3 py-2 border-b bg-muted/20">
                        <button
                          onClick={() => setActiveSection("gradient")}
                          className={`px-3 py-1.5 text-xs font-medium rounded transition ${
                            activeSection === "gradient"
                              ? "bg-background text-foreground shadow-sm"
                              : "text-muted-foreground hover:text-foreground hover:bg-background/50"
                          }`}
                        >
                          Gradient
                        </button>
                        <button
                          onClick={() => setActiveSection("typography")}
                          className={`px-3 py-1.5 text-xs font-medium rounded transition ${
                            activeSection === "typography"
                              ? "bg-background text-foreground shadow-sm"
                              : "text-muted-foreground hover:text-foreground hover:bg-background/50"
                          }`}
                        >
                          Typography
                        </button>
                        <button
                          onClick={() => setActiveSection("actions")}
                          className={`px-3 py-1.5 text-xs font-medium rounded transition ${
                            activeSection === "actions"
                              ? "bg-background text-foreground shadow-sm"
                              : "text-muted-foreground hover:text-foreground hover:bg-background/50"
                          }`}
                        >
                          Actions
                        </button>
                      </div>

                      {/* Gradient Section */}
                      {activeSection === "gradient" && (
                        <div className="flex-1 overflow-auto p-4">
                          <div className="max-w-2xl mx-auto flex flex-col gap-4">
                            {(() => {
                              const gradient = selectedStyle.gradient || {
                                enabled: false,
                                type: "linear" as const,
                                angle: 90,
                                stops: [
                                  { color: "#3b82f6", position: 0 },
                                  { color: "#a855f7", position: 100 },
                                ],
                              };

                              return (
                                <>
                                  {/* Enable Gradient */}
                                  <div className="flex items-center justify-between">
                                    <Label className="text-xs font-medium">Enable Gradient</Label>
                                    <Button
                                      variant={gradient.enabled ? "default" : "outline"}
                                      size="sm"
                                      onClick={() => updateGradient({ enabled: !gradient.enabled })}
                                      className="h-8"
                                    >
                                      {gradient.enabled ? "Enabled" : "Disabled"}
                                    </Button>
                                  </div>

                                  <Separator />

                                  <div className="space-y-3">
                                    <Label className="text-xs font-medium">Gradient Type</Label>
                                    <div className="grid grid-cols-3 gap-2">
                                      <Button
                                        variant={gradient.type === "linear" ? "default" : "outline"}
                                        size="sm"
                                        className="h-20 flex flex-col gap-2"
                                        onClick={() => updateGradient({ type: "linear" })}
                                      >
                                        <div className="h-8 w-full rounded bg-gradient-to-r from-blue-500 to-purple-500"></div>
                                        <span className="text-xs">Linear</span>
                                      </Button>
                                      <Button
                                        variant={gradient.type === "radial" ? "default" : "outline"}
                                        size="sm"
                                        className="h-20 flex flex-col gap-2"
                                        onClick={() => updateGradient({ type: "radial" })}
                                      >
                                        <div className="h-8 w-full rounded bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500"></div>
                                        <span className="text-xs">Radial</span>
                                      </Button>
                                      <Button
                                        variant={gradient.type === "conic" ? "default" : "outline"}
                                        size="sm"
                                        className="h-20 flex flex-col gap-2"
                                        onClick={() => updateGradient({ type: "conic" })}
                                      >
                                        <div className="h-8 w-full rounded bg-[conic-gradient(from_0deg,_#3b82f6,_#a855f7,_#ec4899,_#3b82f6)]"></div>
                                        <span className="text-xs">Conic</span>
                                      </Button>
                                    </div>
                                  </div>

                                  <Separator />

                                  <div className="space-y-3">
                                    <Label className="text-xs font-medium">Gradient Colors</Label>
                                    {gradient.stops.map((stop, index) => (
                                      <div key={index} className="space-y-2">
                                        <div className="flex items-center justify-between">
                                          <span className="text-xs text-muted-foreground">Color Stop {index + 1}</span>
                                          <div className="flex items-center gap-2">
                                            <span className="text-xs text-muted-foreground">{stop.position}%</span>
                                            {gradient.stops.length > 2 && (
                                              <Button
                                                variant="ghost"
                                                size="sm"
                                                className="h-6 w-6 p-0"
                                                onClick={() => {
                                                  const newStops = gradient.stops.filter((_, i) => i !== index);
                                                  updateGradient({ stops: newStops });
                                                }}
                                              >
                                                <X className="h-3 w-3" />
                                              </Button>
                                            )}
                                          </div>
                                        </div>
                                        <div className="flex gap-2">
                                          <input
                                            type="color"
                                            value={stop.color}
                                            onChange={(e) => {
                                              const newStops = [...gradient.stops];
                                              newStops[index] = { ...stop, color: e.target.value };
                                              updateGradient({ stops: newStops });
                                            }}
                                            className="h-10 w-16 rounded border cursor-pointer"
                                          />
                                          <Input
                                            value={stop.color}
                                            onChange={(e) => {
                                              const newStops = [...gradient.stops];
                                              newStops[index] = { ...stop, color: e.target.value };
                                              updateGradient({ stops: newStops });
                                            }}
                                            placeholder="#3b82f6"
                                            className="flex-1 h-10 text-xs"
                                          />
                                        </div>
                                      </div>
                                    ))}

                                    <Button
                                      variant="outline"
                                      size="sm"
                                      className="w-full"
                                      onClick={() => {
                                        const lastStop = gradient.stops[gradient.stops.length - 1];
                                        const newPosition = Math.min(100, (lastStop?.position || 0) + 25);
                                        updateGradient({
                                          stops: [...gradient.stops, { color: "#ec4899", position: newPosition }],
                                        });
                                      }}
                                    >
                                      <Plus className="h-3 w-3 mr-2" />
                                      Add Color Stop
                                    </Button>
                                  </div>

                                  <Separator />

                                  <div className="space-y-3">
                                    <Label className="text-xs font-medium">Gradient Direction ({gradient.angle}°)</Label>
                                    <div className="grid grid-cols-4 gap-2">
                                      {[0, 45, 90, 135, 180, 225, 270, 315].map((angle) => (
                                        <Button
                                          key={angle}
                                          variant={gradient.angle === angle ? "default" : "outline"}
                                          size="sm"
                                          className="h-10 text-xs"
                                          onClick={() => updateGradient({ angle })}
                                        >
                                          {angle}°
                                        </Button>
                                      ))}
                                    </div>
                                  </div>

                                  <Separator />

                                  <div className="space-y-3">
                                    <Label className="text-xs font-medium">Quick Gradient Presets</Label>
                                    <div className="grid grid-cols-2 gap-2">
                                      <Button
                                        variant="outline"
                                        size="sm"
                                        className="h-12 justify-start gap-2"
                                        onClick={() =>
                                          updateGradient({
                                            enabled: true,
                                            type: "linear",
                                            angle: 90,
                                            stops: [
                                              { color: "#3b82f6", position: 0 },
                                              { color: "#8b5cf6", position: 100 },
                                            ],
                                          })
                                        }
                                      >
                                        <div className="h-8 w-8 rounded bg-gradient-to-r from-blue-500 to-purple-500"></div>
                                        <span className="text-xs">Ocean</span>
                                      </Button>
                                      <Button
                                        variant="outline"
                                        size="sm"
                                        className="h-12 justify-start gap-2"
                                        onClick={() =>
                                          updateGradient({
                                            enabled: true,
                                            type: "linear",
                                            angle: 90,
                                            stops: [
                                              { color: "#f97316", position: 0 },
                                              { color: "#ec4899", position: 100 },
                                            ],
                                          })
                                        }
                                      >
                                        <div className="h-8 w-8 rounded bg-gradient-to-r from-orange-500 to-pink-500"></div>
                                        <span className="text-xs">Sunset</span>
                                      </Button>
                                      <Button
                                        variant="outline"
                                        size="sm"
                                        className="h-12 justify-start gap-2"
                                        onClick={() =>
                                          updateGradient({
                                            enabled: true,
                                            type: "linear",
                                            angle: 90,
                                            stops: [
                                              { color: "#10b981", position: 0 },
                                              { color: "#14b8a6", position: 100 },
                                            ],
                                          })
                                        }
                                      >
                                        <div className="h-8 w-8 rounded bg-gradient-to-r from-green-500 to-teal-500"></div>
                                        <span className="text-xs">Forest</span>
                                      </Button>
                                      <Button
                                        variant="outline"
                                        size="sm"
                                        className="h-12 justify-start gap-2"
                                        onClick={() =>
                                          updateGradient({
                                            enabled: true,
                                            type: "linear",
                                            angle: 90,
                                            stops: [
                                              { color: "#a855f7", position: 0 },
                                              { color: "#ec4899", position: 100 },
                                            ],
                                          })
                                        }
                                      >
                                        <div className="h-8 w-8 rounded bg-gradient-to-r from-purple-500 to-pink-500"></div>
                                        <span className="text-xs">Candy</span>
                                      </Button>
                                    </div>
                                  </div>
                                </>
                              );
                            })()}
                          </div>
                        </div>
                      )}

                      {/* Typography Section */}
                      {activeSection === "typography" && (
                        <div className="flex-1 overflow-auto p-4">
                          <div className="max-w-2xl mx-auto flex flex-col gap-4">
                            {/* Font Family */}
                            <div className="space-y-1.5">
                              <Label className="text-xs font-medium">Font Family</Label>
                              <FontPicker
                                value={selectedStyle.fontFamily}
                                onChange={(fontFamily) => updateStyle(selectedStyle.id, { fontFamily })}
                                textColor={selectedStyle.color}
                              />
                            </div>

                            {/* Font Size */}
                            <div className="space-y-1.5">
                              <Label className="text-xs font-medium">Font Size</Label>
                              <Input
                                value={selectedStyle.fontSize}
                                onChange={(e) => updateStyle(selectedStyle.id, { fontSize: e.target.value })}
                                placeholder="16px"
                                className="h-8 text-xs"
                              />
                            </div>

                            {/* Font Weight */}
                            <div className="space-y-1.5">
                              <Label className="text-xs font-medium">Font Weight</Label>
                              <div className="grid grid-cols-9 gap-1">
                                {[100, 200, 300, 400, 500, 600, 700, 800, 900].map((weight) => (
                                  <button
                                    key={weight}
                                    onClick={() => updateStyle(selectedStyle.id, { fontWeight: weight })}
                                    className={`h-8 text-[10px] rounded border transition ${
                                      selectedStyle.fontWeight === weight
                                        ? "bg-primary text-primary-foreground border-primary"
                                        : "hover:bg-accent"
                                    }`}
                                  >
                                    {weight}
                                  </button>
                                ))}
                              </div>
                            </div>

                            {/* Line Height */}
                            <div className="space-y-1.5">
                              <Label className="text-xs font-medium">Line Height</Label>
                              <Input
                                value={selectedStyle.lineHeight}
                                onChange={(e) => updateStyle(selectedStyle.id, { lineHeight: e.target.value })}
                                placeholder="1.5"
                                className="h-8 text-xs"
                              />
                            </div>

                            {/* Letter Spacing */}
                            <div className="space-y-1.5">
                              <Label className="text-xs font-medium">Letter Spacing</Label>
                              <Input
                                value={selectedStyle.letterSpacing}
                                onChange={(e) => updateStyle(selectedStyle.id, { letterSpacing: e.target.value })}
                                placeholder="0"
                                className="h-8 text-xs"
                              />
                            </div>

                            {/* Color */}
                            <div className="space-y-1.5">
                              <Label className="text-xs font-medium">Text Color</Label>
                              <div className="flex gap-2">
                                <input
                                  type="color"
                                  value={selectedStyle.color}
                                  onChange={(e) => updateStyle(selectedStyle.id, { color: e.target.value })}
                                  className="h-8 w-12 rounded border cursor-pointer"
                                />
                                <Input
                                  value={selectedStyle.color}
                                  onChange={(e) => updateStyle(selectedStyle.id, { color: e.target.value })}
                                  placeholder="#000000"
                                  className="flex-1 h-8 text-xs"
                                />
                              </div>
                            </div>
                          </div>
                        </div>
                      )}

                      {/* Actions Section */}
                      {activeSection === "actions" && (
                        <div className="flex-1 overflow-auto p-4">
                          <div className="max-w-2xl mx-auto flex flex-col gap-4">
                            <div className="grid grid-cols-2 gap-2">
                              <Button
                                variant="outline"
                                size="sm"
                                onClick={() => duplicateStyle(selectedStyle.id)}
                                className="h-10 text-xs"
                              >
                                <Copy className="h-3 w-3 mr-2" />
                                Duplicate
                              </Button>
                              <Button
                                variant="outline"
                                size="sm"
                                onClick={exportAsComponent}
                                className="h-10 text-xs"
                              >
                                <FileCode className="h-3 w-3 mr-2" />
                                Export Component
                              </Button>
                              <Button
                                variant="outline"
                                size="sm"
                                onClick={exportAsTokens}
                                className="h-10 text-xs"
                              >
                                <FileJson className="h-3 w-3 mr-2" />
                                Export Tokens
                              </Button>
                              <Button
                                variant="outline"
                                size="sm"
                                onClick={() => {
                                  const css = exportAsCSS();
                                  navigator.clipboard.writeText(css);
                                }}
                                className="h-10 text-xs"
                              >
                                <Download className="h-3 w-3 mr-2" />
                                Copy CSS
                              </Button>
                              <Button
                                variant="destructive"
                                size="sm"
                                onClick={() => deleteStyle(selectedStyle.id)}
                                className="h-10 text-xs col-span-2"
                              >
                                <Trash2 className="h-3 w-3 mr-2" />
                                Delete Style
                              </Button>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}
              </div>
            </div>
          </div>
        </div>
      ) : (
        <div className="flex-1 flex items-center justify-center text-muted-foreground">
          <div className="text-center space-y-2">
            <Type className="h-12 w-12 mx-auto opacity-20" />
            <div className="text-sm">Select or create a typography style</div>
          </div>
        </div>
      )}

      {/* Show collapsed panel button */}
      {isAdvancedPanelCollapsed && (
        <Button
          variant="outline"
          size="sm"
          onClick={() => setIsAdvancedPanelCollapsed(false)}
          className="fixed bottom-4 right-4 shadow-lg"
        >
          <Type className="h-4 w-4 mr-2" />
          Show Advanced Panel
        </Button>
      )}
    </div>
  );
}
